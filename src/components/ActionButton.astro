---
import { Icon } from 'astro-icon/components';

const {
    label = 'Label',
    icon,
    width = 20,
    fontWeight = 300,
    textTransform = 'none',
    noAnimation,
    ...rest
} = Astro.props;
---

<button class=`action-button ${noAnimation ? 'no-animation' : ''}` {...rest}>
    {icon && <Icon name={icon} size={25} width={width} />}

    <div class="label-container">
        <span class="static-text">{label}</span>
    </div>
</button>

<style define:vars={{ fontWeight, textTransform }}>
    /* 1. Base Button Styles */
    .action-button {
        position: relative;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        gap: 0.8rem;
        padding: 0.7rem 1rem;

        background-color: var(--foregroundColor, #ffffff);
        color: var(--backgroundColor, #000000);

        font-weight: var(--fontWeight);
        font-family: 'Urbanist', sans-serif;
        text-transform: var(--textTransform);

        letter-spacing: 0.05em;
        line-height: 1;

        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        overflow: hidden;
        transition:
            background-color 0.3s ease,
            transform 0.1s ease;
    }

    .action-button:hover {
        background-color: var(--accentColor, #e5e5e5);
    }

    .action-button:active {
        transform: scale(0.98);
    }

    .label-container {
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 0.2rem;
    }

    .static-text {
        opacity: 1;
        pointer-events: none;
        user-select: none;
        white-space: nowrap;
        transition: opacity 0.1s;
    }

    :global(.action-button.initialized) .static-text {
        opacity: 0;
    }

    :global(.action-button .anim-layer) {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
        pointer-events: none;
    }

    :global(.action-button .char) {
        display: inline-block;
        position: relative;
        will-change: transform;
    }
</style>

<script>
    import gsap from 'gsap';

    function initButton(button: any) {
        if (button.classList.contains('initialized || no-animation')) return;

        const container = button.querySelector('.label-container');
        const staticText = container.querySelector('.static-text');

        const text = staticText.textContent.trim();
        if (!text) return;

        const cleanup = () => {
            const layers = container.querySelectorAll('.anim-layer');
            layers.forEach((layer: any) => layer.remove());
        };
        cleanup();

        const createLayer = (content: any) => {
            const layer = document.createElement('div');
            layer.classList.add('anim-layer');

            content.split('').forEach((char: string) => {
                const span = document.createElement('span');
                span.classList.add('char');
                span.innerHTML = char === ' ' ? '&nbsp;' : char;
                layer.appendChild(span);
            });
            return layer;
        };

        const layer1 = createLayer(text);
        const layer2 = createLayer(text);

        container.appendChild(layer1);
        container.appendChild(layer2);

        const chars1 = layer1.querySelectorAll('.char');
        const chars2 = layer2.querySelectorAll('.char');

        gsap.set(chars2, { yPercent: 100 });

        const tl = gsap.timeline({
            paused: true,
            defaults: {
                duration: 0.4,
                ease: 'power2.inOut',
                stagger: 0.02,
            },
        });

        tl.to(chars1, { yPercent: -150 }).to(chars2, { yPercent: 0 }, 0.05);

        button.addEventListener('mouseenter', () => {
            tl.play();
        });
        button.addEventListener('mouseleave', () => tl.reverse());
        button.classList.add('initialized');
    }

    const setupAllButtons = () => {
        const buttons = document.querySelectorAll(
            '.action-button:not(.initialized):not(.no-animation)',
        );
        buttons.forEach(initButton);
    };

    setupAllButtons();
    document.addEventListener('astro:page-load', setupAllButtons);
    document.addEventListener('DOMContentLoaded', setupAllButtons);
</script>
